name: Container App update image
description: Update a Container App to a specific ACR image
inputs:
  resourceGroup:
    description: Name of the Resource Group
    required: true
  containerAppName:
    description: Name of the Container App
    required: true
  acrName:
    description: Name of the Azure Container Registry
    required: true
  imageName:
    description: Name of the Docker image
    required: true
  imageVersion:
    description: Version tag for the Docker image
    required: true
  envVars:
    description: Additional environment variables to set (key=value format, space separated)
    required: false

runs:
  using: composite
  steps:
    - name: Update Container App image
      shell: bash
      run: |
        set +e

        IMAGE="${{ inputs.acrName }}.azurecr.io/${{ inputs.imageName }}:${{ inputs.imageVersion }}"
        echo "üöÄ Updating '${{ inputs.containerAppName }}' to '$IMAGE' ..."

        # Construir la lista de env vars: obligatoria + opcionales
        ENV_ARGS="FORCE_REVISION=$(date +%s)"
        if [ -n "${{ inputs.envVars }}" ]; then
          ENV_ARGS="$ENV_ARGS ${{ inputs.envVars }}"
        fi
        echo "$ENV_ARGS"

        az containerapp update \
          --name            "${{ inputs.containerAppName }}" \
          --resource-group  "${{ inputs.resourceGroup }}" \
          --image           "$IMAGE" \
          --set-env-vars    "$ENV_ARGS"

        RESULT=$?
        if [[ $RESULT -eq 0 ]]; then
          echo "‚úÖ Container App image updated successfully."
        else
          echo "‚ùå Failed to update Container App image. Exiting with code $RESULT.""
          exit $RESULT
        fi          