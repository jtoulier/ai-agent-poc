name: Create or Update AKV Secret
description: Create or update a secret in an Azure Key Vault using az subcommand
inputs:
  spInfo:
    description: Service Principal info in JSON format
    required: true
  akvName:
    description: Name of the AKV
    required: true
  secretName:
    description: Name of the secret to create or update
    required: true
  secretValue:
    description: Value of the secret to create or update
    required: true
runs:
  using: composite
  steps:
    - name: Give rol to create an AKV Secret
      shell: bash
      run: |
        set +e

        CLIENT_ID=$(jq -r .clientId <<< '${{ inputs.spInfo }}')
        AKV_ID=$(az keyvault show --name ${{ inputs.akvName }} --query id -o tsv)

        az role assignment create \
          --assignee  $CLIENT_ID \
          --role      "Key Vault Secrets Officer" \
          --scope     $AKV_ID

        RESULT=$?
        if [[ $RESULT -eq 0 ]]; then
          echo "âœ… Role assigned to create AKV Secret successfully."
        else
          echo "âŒ Failed to assign role to create AKV Secret. Exiting with code $RESULT."
          exit $RESULT
        fi

    - name: Create AKV Secret
      shell: bash
      run: |
        set +e

        az keyvault secret show \
          --vault-name  "${{ inputs.akvName }}" \
          --name        "${{ inputs.secretName }}"

        RESULT=$?
        echo "Check command exited with code: $RESULT"

        if [[ $RESULT -eq 0 ]]; then
          echo "âš ï¸ Secret '${{ inputs.secretName }}' already exists. Updating ..."
        else
          echo "ðŸš€ Secret '${{ inputs.secretName }}' not found. Creating ..."
        fi

        az keyvault secret set \
            --vault-name  "${{ inputs.akvName }}" \
            --name        "${{ inputs.secretName }}" \
            --value       "${{ inputs.secretValue }}"

        RESULT=$?
        if [[ $RESULT -eq 0 ]]; then
          echo "âœ… Secret '${{ inputs.secretName }}' created or updated successfully."
        else
          echo "âŒ Failed to create or update secret '${{ inputs.secretName }}'. Exiting with code $RESULT."
          exit $RESULT
        fi