name: WF-98 Delete Infrastructure
on:
  workflow_dispatch:

jobs:
  # job-04-a-delete-sqlserver-firewall-rules
  # No es ncesario eliminar las reglas de firewall del servidor SQL,
  # ya que al eliminar el servidor SQL se eliminan autom√°ticamente.

  job-03-c-delete-frontend-containerapp:
    name: J3C Delete Frontend CAPP
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.INFRA_AZURE_SERVICE_PRINCIPAL_INFO }}

      - name: Delete Frontend Container App
        uses: ./.github/actions/containerapp-delete
        with:
          subscriptionId:   ${{ vars.INFRA_AZURE_SUBSCRIPTION_ID }}

          containerAppName: ${{ vars.INFRA_AZURE_CONTAINERAPP_FRONTEND_NAME }}

          resourceGroup:    ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }}


  job-03-b-delete-adtoken-containerapp:  
    name: J3B Delete AD Token CAPP
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.INFRA_AZURE_SERVICE_PRINCIPAL_INFO }}

      - name: Delete AD Token Container App
        uses: ./.github/actions/containerapp-delete
        with:
          subscriptionId:   ${{ vars.INFRA_AZURE_SUBSCRIPTION_ID }}

          containerAppName: ${{ vars.INFRA_AZURE_CONTAINERAPP_ADTOKENSERVER_NAME }}

          resourceGroup:    ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }}

  job-03-a-delete-backend-containerapp:
    name: J3A Delete Backend CAPP
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.INFRA_AZURE_SERVICE_PRINCIPAL_INFO }}

      - name: Delete Backend Container App
        uses: ./.github/actions/containerapp-delete
        with:
          subscriptionId:   ${{ vars.INFRA_AZURE_SUBSCRIPTION_ID }}

          containerAppName: ${{ vars.INFRA_AZURE_CONTAINERAPP_BACKEND_NAME }}

          resourceGroup:    ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }}
    
  job-02-b-delete-containerapp-environment:
    name: J2B Delete CAPPENV
    runs-on: ubuntu-latest
    needs:  [
              job-03-a-delete-backend-containerapp,
              job-03-b-delete-adtoken-containerapp,
              job-03-c-delete-frontend-containerapp
            ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.INFRA_AZURE_SERVICE_PRINCIPAL_INFO }}

      - name: Delete Container App Environment
        uses: ./.github/actions/resource-delete-if-exists
        with:
          resourceName: ${{ vars.INFRA_AZURE_CONTAINERAPPENVIRONMENT_NAME }}

          checkCmd: |
            az containerapp env show \
              --name            ${{ vars.INFRA_AZURE_CONTAINERAPPENVIRONMENT_NAME }} \
              --resource-group  ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }}

          deleteCmd: |
            az containerapp env delete \
              --name            ${{ vars.INFRA_AZURE_CONTAINERAPPENVIRONMENT_NAME }} \
              --resource-group  ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }} \
              --yes

      - name: Wait for Container App Environment to be deleted
        uses: ./.github/actions/containerapp-env-wait-state
        with:
          resourceGroup:    ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }}
          environmentName:  ${{ vars.INFRA_AZURE_CONTAINERAPPENVIRONMENT_NAME }}
          desiredState:     NotFound
          sleepSeconds:     '15'
          totalWaitSeconds: '900'

  job-02-a-delete-sqldatabase:
    name: J2A Delete SQL DB
    runs-on: ubuntu-latest
    needs:  [
              job-03-a-delete-backend-containerapp
            ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.INFRA_AZURE_SERVICE_PRINCIPAL_INFO }}

      - name: Delete SQL DB
        uses: ./.github/actions/resource-delete-if-exists
        with:
          resourceName: ${{ vars.INFRA_AZURE_SQLSERVER_DB_NAME }}

          checkCmd: |
            az sql db show \
              --name            ${{ vars.INFRA_AZURE_SQLSERVER_DB_NAME }} \
              --resource-group  ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }} \
              --server          ${{ vars.INFRA_AZURE_SQLSERVER_NAME }}

          deleteCmd: |
            az sql db delete \
              --name            ${{ vars.INFRA_AZURE_SQLSERVER_DB_NAME }} \
              --resource-group  ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }} \
              --server          ${{ vars.INFRA_AZURE_SQLSERVER_NAME }} \
              --yes

  job-01-d-delete-loganalytics:
    name: J1D Delete LAWS
    runs-on: ubuntu-latest
    needs: job-02-b-delete-containerapp-environment
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.INFRA_AZURE_SERVICE_PRINCIPAL_INFO }}

      - name: Delete LAWS
        uses: ./.github/actions/resource-delete-if-exists
        with:
          resourceName: ${{ vars.INFRA_AZURE_LOGANALYTICSWORKSPACE_NAME }}

          checkCmd: |
            az monitor log-analytics workspace show \
              --resource-group  ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }} \
              --workspace-name  ${{ vars.INFRA_AZURE_LOGANALYTICSWORKSPACE_NAME }}

          deleteCmd: |
            az monitor log-analytics workspace delete \
              --resource-group  ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }} \
              --workspace-name  ${{ vars.INFRA_AZURE_LOGANALYTICSWORKSPACE_NAME }} \
              --force           yes \
              --yes

  job-01-c-delete-sqlserver:
    name: J1C Delete SQL SRV
    runs-on: ubuntu-latest
    needs: job-02-a-delete-sqldatabase
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.INFRA_AZURE_SERVICE_PRINCIPAL_INFO }}

      - name: Delete SQL Server
        uses: ./.github/actions/resource-delete-if-exists
        with:
          resourceName: ${{ vars.INFRA_AZURE_SQLSERVER_NAME }}

          checkCmd: |
            az sql server show \
              --name            ${{ vars.INFRA_AZURE_SQLSERVER_NAME }} \
              --resource-group  ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }}

          deleteCmd: |
            az sql server delete \
              --name            ${{ vars.INFRA_AZURE_SQLSERVER_NAME }} \
              --resource-group  ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }} \
              --yes

  job-01-b-delete-akv:
    name: J1B Delete AKV
    runs-on: ubuntu-latest
    needs: job-03-a-delete-backend-containerapp
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.INFRA_AZURE_SERVICE_PRINCIPAL_INFO }}

      - name: Delete Azure Key Vault
        uses: ./.github/actions/resource-delete-if-exists
        with:
          resourceName: ${{ vars.INFRA_AZURE_AKV_NAME }}

          checkCmd: |
            az keyvault show \
              --name            ${{ vars.INFRA_AZURE_AKV_NAME }} \
              --resource-group  ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }}

          deleteCmd: |
            az keyvault delete \
              --name            ${{ vars.INFRA_AZURE_AKV_NAME }} \
              --resource-group  ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }}

      - name: Purge Azure Key Vault
        uses: ./.github/actions/akv-purge-if-exists
        with:
          akvName: ${{ vars.INFRA_AZURE_AKV_NAME }}

  job-01-a-delete-acr:
    name: J1A Delete ACR
    runs-on: ubuntu-latest
    needs:  [
              job-03-c-delete-frontend-containerapp,
              job-03-b-delete-adtoken-containerapp,
              job-03-a-delete-backend-containerapp
            ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.INFRA_AZURE_SERVICE_PRINCIPAL_INFO }}

      - name: Delete Azure Container Registry
        uses: ./.github/actions/resource-delete-if-exists
        with:
          resourceName: ${{ vars.INFRA_AZURE_ACR_NAME }}

          checkCmd: |
            az acr show \
              --resource-group  ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }} \
              --name            ${{ vars.INFRA_AZURE_ACR_NAME }}

          deleteCmd: |
            az acr delete \
              --resource-group  ${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }} \
              --name            ${{ vars.INFRA_AZURE_ACR_NAME }} \
              --yes