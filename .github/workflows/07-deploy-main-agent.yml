name: WF07 - Deploy Main Agent to Azure

on:
  workflow_dispatch:

jobs:
  job-dummy:
    name: Prerequisites for Deploying Main Agent to Azure
    runs-on: ubuntu-latest
    steps:
      - name: Show pre requisites
        run: |
          echo "‚ö†Ô∏è Prerequisites:"
          echo ""
          echo "1.a Ir a https://ai.azure.com/resources"
          echo "1.b Dar clic en 'Create new'"
          echo ""
          echo "2.a. Seleccionar 'Azure AI Foundry resource'"
          echo "2.b. Dar clic en 'Next'"
          echo ""
          echo "3.a Nombrar al Project como '${{ vars.INFRA_AZURE_AIFOUNDRY_PROJECT_NAME }}'"
          echo "3.b Expandir 'Advanced options'"
          echo "3.c Nombrar al Azure AI Foundry resource como '${{ vars.INFRA_AZURE_AIFOUNDRY_RESOURCE_NAME }}'"
          echo "3.d Seleccionar la suscripci√≥n '${{ vars.INFRA_AZURE_SUBSCRIPTION_NAME }}'"
          echo "3.e Seleccionar el grupo de recursos '${{ vars.INFRA_AZURE_RESOURCEGROUP_NAME }}'"
          echo "3.f Seleccionar la regi√≥n '${{ vars.INFRA_AZURE_LOCATION }}'"
          echo "3.g Dar clic en 'Create'"
          echo ""
          echo "4.a Esperar a que se cree el recurso (puede tardar varios minutos)"
          echo ""
          echo "5.a En el men√∫ lateral izquierdo, ubicar 'Build and customize' y luego dar clic en 'Agents'"
          echo "5.b Se debe abrir autom√°ticamente la pantalla 'Deploy a model'"
          echo "5.c Seleccionar el modelo '${{ vars.INFRA_AZURE_AIFOUNDRY_MODEL_NAME }}'"
          echo "5.d Dar clic en 'Confirm'"
          echo "5.e Nombrar el Deployment como '${{ vars.INFRA_AZURE_AIFOUNDRY_DEPLOYMENT_NAME }}'"
          echo "5.f Dar clic en 'Deploy'"
          echo ""
          echo "6.a Dar clic en el nombre del Agente creado. Tiene un nombre aleatorio"
          echo "6.b Nombrar el Agent name como '${{ vars.INFRA_AZURE_AIFOUNDRY_AGENT_NAME }}'"
          echo "6.c Dar clic en una zona en blanco de la pantalla para que se guarden los cambios"
          echo ""
          echo "7.a Tomar nota del valor de 'Agent ID'"

          echo "Ir a prjcantolao"
          echo "Access control (IAM)"
          echo "Grant access to this resource -> Add role assignment"
          echo "Cognitive Services OpenAI Contributor"
          echo "+ Select members -> github-sp"
          echo "Select -> Review + assign"

  job-configure-main-agent:
    name: Configure Main Agent instructions and tools
    runs-on: ubuntu-latest
    env:
      PROJECT_ENDPOINT: ${{ vars.INFRA_AZURE_AIFOUNDRY_RESOURCE_NAME }}.services.ai.azure.com/api/projects/${{ vars.INFRA_AZURE_AIFOUNDRY_PROJECT_NAME }}
      AGENT_NAME: ${{ vars.INFRA_AZURE_AIFOUNDRY_AGENT_NAME }}
      TOOL_NAME: ${{ vars.INFRA_AZURE_AIFOUNDRY_AGENT_TOOL_NAME }}
      TOOL_DESCRIPTION: ${{ vars.INFRA_AZURE_AIFOUNDRY_AGENT_TOOL_DESCRIPTION }}
    needs: job-dummy
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.INFRA_AZURE_SERVICE_PRINCIPAL_INFO }}

      - name: Configure Main Agent instructions and tools
        run: |
          ACCESS_TOKEN=$(az account get-access-token \
            --resource https://ai.azure.com \
            --query accessToken -o tsv)

          echo "üîé Buscando agente con nombre: $AGENT_NAME"

          curl \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            https://$PROJECT_ENDPOINT/assistants?api-version=2025-05-01

          AGENT_ID=$(curl -s \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            https://$PROJECT_ENDPOINT/assistants?api-version=2025-05-01 \
            | jq -r --arg AGENT_NAME "$AGENT_NAME" '.data[] | select(.name==$AGENT_NAME) | .id')

          echo $AGENT_ID

          if [ -z "$AGENT_ID" ]; then
            echo "‚ùå No se encontr√≥ el agente con nombre $AGENT_NAME"
            exit 1
          fi

          echo "‚úÖ Agent ID encontrado: $AGENT_ID"
          echo "AGENT_ID=$AGENT_ID" >> $GITHUB_ENV
          
          echo "üõ†Ô∏è Configurando instrucciones del agente principal..."



          # Escapar las instrucciones para JSON (RECOMENDADO)
          INSTRUCTIONS=$(cat ./main-agent/instructions/credits.txt | jq -Rs .)
          
          # Este s√≠ funcion√≥
          # INSTRUCTIONS=$(cat ./main-agent/instructions/credits.txt | sed 's/"/\\"/g')
          
          # Juntar varios archvios en uno solo y en orden alfab√©tico
          # cat ./main-agent/instructions/*.txt > ./main-agent/instructions/combined_instructions.txt
          # INSTRUCTIONS=$(cat ./main-agent/instructions/combined_instructions.txt | jq -Rs .)

          echo $INSTRUCTIONS


          # Crear o actualizar el agente
          curl -v -X POST https://$PROJECT_ENDPOINT/assistants/$AGENT_ID?api-version=2025-05-01 \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
                  \"name\": \"$AGENT_NAME\",
                  \"instructions\": \"$INSTRUCTIONS\"
                }"

          echo "‚úÖ Agente con Instrucciones configuradas correctamente"


      - name: Configure Main Agent tools
        if: false
        run: |
          ACCESS_TOKEN=$(az account get-access-token \
            --resource https://ai.azure.com \
            --query accessToken -o tsv)

          echo "üîé Buscando agente con nombre: $AGENT_NAME"

          curl \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            https://$PROJECT_ENDPOINT/assistants?api-version=2025-05-01

          AGENT_ID=$(curl -s \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            https://$PROJECT_ENDPOINT/assistants?api-version=2025-05-01 \
            | jq -r --arg AGENT_NAME "$AGENT_NAME" '.data[] | select(.name==$AGENT_NAME) | .id')

          echo $AGENT_ID

          if [ -z "$AGENT_ID" ]; then
            echo "‚ùå No se encontr√≥ el agente con nombre $AGENT_NAME"
            exit 1
          fi

          echo "‚úÖ Agent ID encontrado: $AGENT_ID"
          echo "AGENT_ID=$AGENT_ID" >> $GITHUB_ENV
          
          echo "üõ†Ô∏è Configurando herramientas del agente principal..."


          OPENAPI_SPEC=$(cat ./backend/src/main/resources/openapi/openapi.json)

          echo $OPENAPI_SPEC


          # Crear o actualizar el agente
          curl -v -X POST https://$PROJECT_ENDPOINT/assistants/$AGENT_ID?api-version=2025-05-01 \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
                  \"name\": \"$AGENT_NAME\",
                  \"tools\": [
                    {
                      \"type\": \"openapi\",
                      \"openapi\": {
                        \"name\": \"$TOOL_NAME\",
                        \"description\": \"$TOOL_DESCRIPTION\",
                        \"spec\": $OPENAPI_SPEC,
                        \"auth\": {
                           \"type\": \"anonymous\",
                           \"security_scheme\": {}
                        }
                      }
                    }
                  ]
                }"

          echo "‚úÖ Agente configurado correctamente"
